<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>포켓몬 페널티킥</title>
  <style>
    :root{
      --field:#2e7d32;
      --line:#ffffff;
      --goal:#e0e0e0;
      --net:#cfd8dc;
      --arrow:#ffffff66;
      --arrow-active:#ffffffcc;
      --shadow:#00000040;
      --goalLeft:16%;
      --goalRight:16%;
      --goalTop:6%;
      --goalHeight:39%;
      --aimInnerPad:12px;
      --msgW:168px;
      --msgH:22px;

      /* z-index helpers (순서 변경) */
      --z-aim:5;
      --z-ball:40;
      --z-keeper-shell:45; /* 등껍질을 가장 위로 올림 */
      --z-keeper-head:30;
      --z-keeper-eye:35;
      --z-keeper-body:8;
      --z-kicker:22;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
      background:#0f1416;color:#f1f1f1;display:flex;flex-direction:column;align-items:center;
      min-height:100vh;padding:20px;
    }

    .wrap{width:min(980px,96vw)}
    h1{margin:8px 0 6px;font-size:clamp(20px,3.2vw,28px);text-align:center}
    .tip{margin:0 0 10px;text-align:center;color:#cfd8dc;font-size:14px}
    .hud{display:flex;gap:10px;justify-content:center;margin-bottom:8px;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;background:#263238;color:#e0f2f1;font-weight:700;font-size:14px;box-shadow:0 2px 8px #0006}
    .controls{display:flex;gap:8px;align-items:center}
    .input{background:#37474f;border:1px solid #263238;padding:6px 8px;border-radius:8px;color:#e0f2f1;width:120px;text-align:center}
    .btn{background:var(--accent,#00bcd4);color:#042024;font-weight:700;padding:6px 10px;border-radius:8px;cursor:pointer;border:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .arena{
      position:relative;
      aspect-ratio:16/9;
      width:100%;
      background:linear-gradient(#2e7d32,#1b5e20);
      border-radius:16px;overflow:hidden;box-shadow:0 10px 30px #0009;
      touch-action:none;
    }

    .goal{
      position:absolute;left:var(--goalLeft);right:var(--goalRight);top:var(--goalTop);height:var(--goalHeight);
      border:10px solid var(--goal);border-bottom:none;border-radius:14px 14px 0 0;
      background:repeating-linear-gradient(90deg,var(--net) 0 2px,transparent 2px 18px),repeating-linear-gradient(0deg,var(--net) 0 2px,transparent 2px 18px);
    }

    .line{position:absolute;inset:auto 8% 15% 8%;border:2px solid var(--line);border-top:none;border-radius:0 0 14px 14px}
    .spot{position:absolute;left:50%;bottom:13.8%;width:10px;height:10px;margin-left:-5px;border-radius:50%;background:var(--line)}

    /* Keeper - z-index 수정: shell이 제일 위 */
    .keeper{position:absolute;left:50%;width:96px;height:106px;transform:translateX(-50%);animation:idle 1.05s ease-in-out infinite alternate;z-index:12;will-change:transform;overflow:visible}
    @keyframes idle{from{transform:translateX(-52%)}to{transform:translateX(-48%)}}

    .keeper .head{position:absolute;left:50%;top:6px;width:76px;height:62px;transform:translateX(-50%);background:#4fc3f7;border:3px solid #0288d1;border-radius:44px;z-index:var(--z-keeper-head);}
    .keeper .eye{position:absolute;top:20px;width:14px;height:18px;background:#fff;border:2px solid #1b1b1b;border-radius:10px;z-index:var(--z-keeper-eye);}
    .keeper .eye.left{left:12px}
    .keeper .eye.right{right:12px}
    .keeper .pupil{position:absolute;left:50%;top:50%;width:8px;height:10px;transform:translate(-50%,-35%);background:#1b1b1b;border-radius:6px;}

    .keeper .torso{position:absolute;left:50%;top:36px;width:72px;height:56px;transform:translateX(-50%);background:#4fc3f7;border:3px solid #0288d1;border-radius:36px;box-shadow:0 6px 12px var(--shadow);z-index:var(--z-keeper-body)}
    .keeper .belly{position:absolute;left:50%;top:48px;width:48px;height:36px;transform:translateX(-50%);background:#ffe0b2;border:3px solid #efcc96;border-radius:40px/30px;z-index:calc(var(--z-keeper-body)+1)}

    .keeper .arm{position:absolute;top:62px;width:18px;height:26px;background:#4fc3f7;border:3px solid #0288d1;border-radius:12px;z-index:10}
    .keeper .arm.left{left:2px;transform:rotate(-14deg)}
    .keeper .arm.right{right:2px;transform:rotate(14deg)}
    .keeper .leg{position:absolute;bottom:6px;width:20px;height:16px;background:#4fc3f7;border:3px solid #0288d1;border-radius:12px;z-index:10}
    .keeper .leg.left{left:24px}
    .keeper .leg.right{right:24px}

    /* Shell: 제일 위 (공을 막는 듯한 효과) */
    .keeper .shell{
      position:absolute;left:50%;top:20px;width:80px;height:74px;
      transform:translateX(-50%);
      background:#8d6e63;border:4px solid #5d4037;border-radius:44px/36px;
      box-shadow:inset 0 0 0 10px #bcaaa4;
      z-index:var(--z-keeper-shell);
    }

    .keeper .shell .panel{
      position:absolute;inset:8px;border-radius:34px/28px;
      background:
      linear-gradient(90deg,rgba(0,0,0,0.06) 0 2px,transparent 2px 100%),
      linear-gradient(0deg,rgba(255,255,255,0.03) 0 2px,transparent 2px 100%),
      linear-gradient(90deg,rgba(122,94,85,0.10) 0 1px,transparent 1px),
      linear-gradient(0deg,rgba(122,94,85,0.10) 0 1px,transparent 1px);
      background-size:28px 100%,100% 18px,12px 100%,100% 12px;
    }

    /* 나머지는 동일 */
    .kicker{position:absolute;left:50%;bottom:10%;width:84px;height:84px;transform:translateX(-50%);z-index:var(--z-kicker);pointer-events:none}
    .kicker .body{position:absolute;inset:0;border-radius:50%;background:#ffd600;border:3px solid #ffb300;box-shadow:0 6px 12px var(--shadow);}
    .kicker .ear{position:absolute;width:20px;height:36px;background:#ffd600;border:3px solid #ffb300;border-bottom:none;top:-20px;border-radius:10px 10px 0 0;transform-origin:bottom center;}
    .kicker .ear.left{left:12px;transform:rotate(-14deg)}
    .kicker .ear.right{right:12px;transform:rotate(14deg)}
    .kicker .ear:after{content:"";position:absolute;inset:0;height:14px;background:#1b1b1b;border-radius:10px 10px 0 0;}
    .kicker.shoot .body{animation:bump .18s ease}
    @keyframes bump{50%{transform:scale(.95)}}

    .ball{--d:40px;position:absolute;left:50%;bottom:14%;width:var(--d);height:var(--d);margin-left:calc(var(--d)/-2);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 14px rgba(0,0,0,0.5);z-index:var(--z-ball)}
    .ball .shell{position:relative;width:88%;height:88%;border-radius:50%;background:linear-gradient(to bottom,#e53935 0%,#e53935 50%,#ffffff 50%,#f7f7f7 100%);border:3px solid #111;}

    .aim{position:absolute;left:var(--goalLeft);right:var(--goalRight);top:var(--goalTop);height:var(--goalHeight);display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px;padding:var(--aimInnerPad);z-index:var(--z-aim)}
    .aim .cell{border:2px dashed var(--arrow);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .aim .cell.active{border-color:var(--accent,#00bcd4);box-shadow:0 0 0 4px var(--accent,#00bcd4)22 inset;}
    .aim .cell[data-dir="0"]::after{content:"↖"} .aim .cell[data-dir="1"]::after{content:"↑"} .aim .cell[data-dir="2"]::after{content:"↗"}
    .aim .cell[data-dir="3"]::after{content:"←"} .aim .cell[data-dir="4"]::after{content:"•"} .aim .cell[data-dir="5"]::after{content:"→"}
    .aim .cell[data-dir="6"]::after{content:"↙"} .aim .cell[data-dir="7"]::after{content:"↓"} .aim .cell[data-dir="8"]::after{content:"↘"}

    #arena .message{position:absolute;left:50%;top:calc(var(--goalTop) + var(--goalHeight) + 2%);transform:translateX(-50%);width:var(--msgW);height:var(--msgH);padding:4px 8px;font-size:11px;line-height:11px;font-weight:600;display:none;align-items:center;justify-content:center;text-align:center;background:#263238;border-radius:8px;color:#e0f2f1;z-index:50}
    #arena .message.show{display:inline-flex}
    #arena .message.goal{background:#2da7e5}
    #arena .message.save{background:#ed3853}

    table.top10{width:520px;border-collapse:collapse;text-align:center;background:#0f1416;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(0,0,0,0.6);font-size:14px}
    table.top10 thead th{padding:10px 6px;font-size:13px;color:#cfeff5;background:linear-gradient(180deg,#111417,#0f1416);}
    table.top10 tbody td{padding:8px 6px;font-weight:700;color:#eaf7f9;border-top:1px solid rgba(255,255,255,0.02);}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>포켓몬 페널티킥 — 개선판 (등껍질/키보드/Top50)</h1>
    <div class="hud">
      <div class="controls">
        <input id="studentId" class="input" placeholder="학번 (10101)" maxlength="5" inputmode="numeric" />
        <button id="startBtn" class="btn">Start</button>
      </div>
      <div class="badge">현재 조준: <span id="aimLabel">• (가운데)</span></div>
      <div class="badge">연속 골: <span id="streak">0</span></div>
      <div class="badge" style="background:#2b2b2b">최고: <span id="best">—</span></div>
    </div>

    <div class="arena" id="arena" tabindex="0">
      <div class="goal"></div>
      <div class="line"></div>
      <div class="spot"></div>
      <div class="keeper" id="keeper">
        <div class="head"><div class="eye left"><div class="pupil"></div></div><div class="eye right"><div class="pupil"></div></div></div>
        <div class="torso"></div><div class="belly"></div>
        <div class="arm left"></div><div class="arm right"></div>
        <div class="leg left"></div><div class="leg right"></div>
        <div class="shell"><div class="panel"></div></div>
      </div>
      <div class="kicker" id="kicker"><div class="ear left"></div><div class="ear right"></div><div class="body"></div></div>
      <div class="ball" id="ball"><div class="shell"></div><div class="band"></div><div class="center"></div><div class="shine"></div></div>
      <div class="aim" id="aimGrid"></div>
      <div class="message" id="msg"></div>
    </div>

    <div class="bottomTableWrap">
      <table class="top10" id="top10Table">
        <thead><tr><th>순위</th><th>학번</th><th>연속골</th></tr></thead>
        <tbody id="top10Body"><tr><td colspan="3">로딩 중...</td></tr></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzF6CGY4PcDrnQ9gInEPJsQI-ctpwupUM",
      authDomain: "pkgame-7464c.firebaseapp.com",
      projectId: "pkgame-7464c",
      storageBucket: "pkgame-7464c.firebasestorage.app",
      messagingSenderId: "332773265897",
      appId: "1:332773265897:web:7abb782f55daa85a073b78",
      measurementId: "G-398N8VPTMQ"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();

    (() => {
      const arena = document.getElementById('arena');
      const keeper = document.getElementById('keeper');
      const kicker = document.getElementById('kicker');
      const ball = document.getElementById('ball');
      const msg = document.getElementById('msg');
      const streakEl = document.getElementById('streak');
      const aimLabel = document.getElementById('aimLabel');
      const aimGrid = document.getElementById('aimGrid');
      const studentInput = document.getElementById('studentId');
      const startBtn = document.getElementById('startBtn');
      const bestEl = document.getElementById('best');

      const dirText = ["↖","↑","↗","←","•","→","↙","↓","↘"];
      let aimDir = 4, ready = true, currentUser=null, streak=0, best=0;

      // 조준 UI
      for(let i=0;i<9;i++){
        const c=document.createElement('div');
        c.className='cell';
        c.dataset.dir=i;
        if(i===4)c.classList.add('active');
        c.addEventListener('click',()=>setAim(i));
        aimGrid.appendChild(c);
      }

      function setAim(d){
        aimDir=d;
        aimLabel.textContent=`${dirText[d]} (${['↖','↑','↗','←','•','→','↙','↓','↘'][d]})`;
        document.querySelectorAll('.cell').forEach(c=>c.classList.toggle('active',c.dataset.dir==d));
      }

      // 키보드 입력 → aimDir 갱신
      arena.addEventListener('keydown',e=>{
        const map={ArrowUp:1,ArrowDown:7,ArrowLeft:3,ArrowRight:5,
                   w:1,a:3,s:7,d:5,q:0,e:2,z:6,c:8};
        if(map[e.key]!=null){ setAim(map[e.key]); e.preventDefault(); }
        if(e.code==='Space'||e.code==='Enter'){ if(ready)shoot(); }
      });

      function showMessage(t,cls){msg.textContent=t;msg.className='message show '+cls;setTimeout(()=>msg.className='message',1100);}
      function rand(min,max){return Math.random()*(max-min)+min;}
      function getRandDir(){return Math.floor(Math.random()*9);}

      async function shoot(){
        if(!ready||!currentUser)return;
        ready=false;
        kicker.classList.add('shoot');
        setTimeout(()=>kicker.classList.remove('shoot'),200);
        const keeperDir=getRandDir();
        moveKeeper(keeperDir);
        moveBall(aimDir);
        const isGoal=(aimDir!==keeperDir);
        setTimeout(()=>{if(isGoal)goal();else save();},620);
      }

      function moveKeeper(d){
        const range=24;
        const dx=(d%3-1)*range,dy=(Math.floor(d/3)-1)*range;
        keeper.animate([{transform:`translate(-50%,0)`},{transform:`translate(calc(-50% + ${dx}px),${dy}px)`}],{duration:600,fill:'forwards',easing:'ease-out'});
      }
      function moveBall(d){
        const rangeX=90,rangeY=120;
        const dx=(d%3-1)*rangeX,dy=(Math.floor(d/3)-1)*rangeY;
        ball.animate([{transform:'translate(0,0)'},{transform:`translate(${dx}px,${dy-220}px)`}],{duration:600,fill:'forwards',easing:'ease-in'});
      }
      function resetPositions(){
        keeper.getAnimations().forEach(a=>a.cancel());
        ball.getAnimations().forEach(a=>a.cancel());
      }

      async function goal(){
        showMessage('GOAL!','goal');
        streak++;streakEl.textContent=streak;
        if(streak>best){best=streak;bestEl.textContent=best;updateBest();}
        setTimeout(()=>{resetPositions();ready=true;},1000);
      }
      function save(){
        showMessage('세이브!','save');
        streak=0;streakEl.textContent=0;
        setTimeout(()=>{resetPositions();ready=true;},1000);
      }

      async function updateBest(){
        const ref=doc(db,'scores',currentUser);
        await runTransaction(db,async(tx)=>{
          const snap=await tx.get(ref);
          if(!snap.exists())tx.set(ref,{best:best});
          else if(best>snap.data().best)tx.update(ref,{best:best});
        });
      }

      startBtn.addEventListener('click',async()=>{
        const id=studentInput.value.trim();
        if(!/^\d{5}$/.test(id)){alert('학번을 정확히 입력해주세요.');return;}
        currentUser=id;
        const snap=await getDoc(doc(db,'scores',id));
        best=snap.exists()?snap.data().best||0:0;
        bestEl.textContent=best;
        streak=0;streakEl.textContent=0;
        ready=true;
        arena.focus();
      });

      // 실시간 Top50
      const q=query(collection(db,'scores'),orderBy('best','desc'),limit(50));
      const tbody=document.getElementById('top10Body');
      onSnapshot(q,(ss)=>{
        tbody.innerHTML='';
        let r=1;
        ss.forEach(d=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r}</td><td>${d.id}</td><td>${d.data().best||0}</td>`;
          tbody.appendChild(tr);
          r++;
        });
      });
    })();
  </script>
</body>
</html>
