<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>포켓몬 페널티킥(홍정보)</title>
  <style>
    :root {
      --field: #2e7d32;
      --line: #ffffff;
      --goal: #e0e0e0;
      --net: #cfd8dc;
      --arrow: #ffffff66;
      --arrow-active: #ffffffcc;
      --shadow: #00000040;
      --goalLeft: 16%;
      --goalRight: 16%;
      --goalTop: 6%;
      --goalHeight: 39%;
      --aimInnerPad: 12px;
      --msgW: 168px;
      --msgH: 22px;
      --accent: #00bcd4;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
      background: #0f1416;
      color: #f1f1f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .wrap {
      width: min(880px, 95vw);
    }

    h1 {
      margin: 8px 0 6px;
      font-size: clamp(20px, 3.2vw, 28px);
      text-align: center
    }

    .tip {
      margin: 0 0 10px;
      text-align: center;
      color: #cfd8dc;
      font-size: 14px
    }

    .hud {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 8px;
      flex-wrap: wrap
    }

    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: #263238;
      color: #e0f2f1;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 8px #0006;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .input {
      background: #37474f;
      border: 1px solid #263238;
      padding: 6px 8px;
      border-radius: 8px;
      color: #e0f2f1;
      width: 120px;
      text-align: center;
    }

    .btn {
      background: var(--accent);
      color: #042024;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
    }

    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    .arena {
      position: relative;
      aspect-ratio: 16/9;
      width: 100%;
      background: linear-gradient(#2e7d32, #1b5e20);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px #0009;
    }

    .goal {
      position: absolute;
      left: var(--goalLeft);
      right: var(--goalRight);
      top: var(--goalTop);
      height: var(--goalHeight);
      border: 10px solid var(--goal);
      border-bottom: none;
      border-radius: 14px 14px 0 0;
      background:
        repeating-linear-gradient(90deg, var(--net) 0 2px, transparent 2px 18px),
        repeating-linear-gradient(0deg, var(--net) 0 2px, transparent 2px 18px);
    }

    .line {
      position: absolute;
      inset: auto 8% 15% 8%;
      border: 2px solid var(--line);
      border-top: none;
      border-radius: 0 0 14px 14px;
    }

    .spot {
      position: absolute;
      left: 50%;
      bottom: 13.8%;
      width: 10px;
      height: 10px;
      margin-left: -5px;
      border-radius: 50%;
      background: var(--line);
    }

    /* Keeper (꼬부기) — shell을 전면으로 키우고 패널 격자 추가 */
    .keeper {
      position: absolute;
      left: 50%;
      width: 96px;
      height: 106px;
      transform: translateX(-50%);
      animation: idle 1.05s ease-in-out infinite alternate;
      z-index: 6;
    }

    @keyframes idle {
      from {
        transform: translateX(-52%);
      }

      to {
        transform: translateX(-48%);
      }
    }

    .keeper .head {
      position: absolute;
      left: 50%;
      top: 6px;
      width: 76px;
      height: 62px;
      transform: translateX(-50%);
      background: #4fc3f7;
      border: 3px solid #0288d1;
      border-radius: 44px;
      z-index: 6;
    }

    .keeper .eye {
      position: absolute;
      top: 20px;
      width: 14px;
      height: 18px;
      background: #fff;
      border: 2px solid #1b1b1b;
      border-radius: 10px;
      z-index: 7;
    }

    .keeper .eye.left {
      left: 12px;
    }

    .keeper .eye.right {
      right: 12px;
    }

    .keeper .pupil {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 8px;
      height: 10px;
      transform: translate(-50%, -35%);
      background: #1b1b1b;
      border-radius: 6px;
    }

    .keeper .torso {
      position: absolute;
      left: 50%;
      top: 36px;
      width: 72px;
      height: 56px;
      transform: translateX(-50%);
      background: #4fc3f7;
      border: 3px solid #0288d1;
      border-radius: 36px;
      box-shadow: 0 6px 12px var(--shadow);
      z-index: 4;
    }

    .keeper .belly {
      position: absolute;
      left: 50%;
      top: 48px;
      width: 48px;
      height: 36px;
      transform: translateX(-50%);
      background: #ffe0b2;
      border: 3px solid #efcc96;
      border-radius: 40px/30px;
      z-index: 5;
    }

    .keeper .arm {
      position: absolute;
      top: 62px;
      width: 18px;
      height: 26px;
      background: #4fc3f7;
      border: 3px solid #0288d1;
      border-radius: 12px;
      z-index: 3;
    }

    .keeper .arm.left {
      left: 2px;
      transform: rotate(-14deg);
    }

    .keeper .arm.right {
      right: 2px;
      transform: rotate(14deg);
    }

    .keeper .leg {
      position: absolute;
      bottom: 6px;
      width: 20px;
      height: 16px;
      background: #4fc3f7;
      border: 3px solid #0288d1;
      border-radius: 12px;
      z-index: 3;
    }

    .keeper .leg.left {
      left: 24px;
    }

    .keeper .leg.right {
      right: 24px;
    }

    /* Shell (앞으로 나온 모습) — 크기 키움, 격자 패턴을 선명하게 */
    .keeper .shell {
      position: absolute;
      left: 50%;
      top: 28px;
      width: 74px;
      height: 66px;
      transform: translateX(-50%);
      background: #8d6e63;
      border: 4px solid #5d4037;
      border-radius: 44px/36px;
      box-shadow: inset 0 0 0 10px #bcaaa4;
      overflow: visible;
      z-index: 8;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 상세 격자 패널: 굵은 패널 라인 + 내부 얇은 격자 */
    .keeper .shell .panel {
      position: absolute;
      inset: 8px;
      border-radius: 34px/28px;
      overflow: hidden;
      background:
        /* 세로 가는 굵은 패널 라인 (간격 넓게) */
        linear-gradient(90deg, rgba(0, 0, 0, 0.06) 0 2px, transparent 2px 100%),
        /* 가로 가는 굵은 패널 라인 */
        linear-gradient(0deg, rgba(255, 255, 255, 0.03) 0 2px, transparent 2px 100%),
        /* 더 촘촘한 미세 격자 (반투명) */
        linear-gradient(90deg, rgba(122, 94, 85, 0.10) 0 1px, transparent 1px),
        linear-gradient(0deg, rgba(122, 94, 85, 0.10) 0 1px, transparent 1px);
      background-size: 28px 100%, 100% 18px, 12px 100%, 100% 12px;
    }

    .keeper .shell .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.15), inset 0 -3px 6px rgba(255, 255, 255, 0.03);
      pointer-events: none;
    }

    /* Kicker (피카츄) - 귀 원래 스타일(처음처럼 둥글고 윗부분 있는 형태) */
    .kicker {
      position: absolute;
      left: 50%;
      bottom: 10%;
      width: 84px;
      height: 84px;
      transform: translateX(-50%);
      z-index: 7;
    }

    .kicker .body {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: #ffd600;
      border: 3px solid #ffb300;
      box-shadow: 0 6px 12px var(--shadow);
      z-index: 1;
    }

    .kicker .ear {
      position: absolute;
      width: 20px;
      height: 36px;
      background: #ffd600;
      border: 3px solid #ffb300;
      border-bottom: none;
      top: -20px;
      border-radius: 10px 10px 0 0;
      transform-origin: bottom center;
      z-index: 8;
    }

    .kicker .ear.left {
      left: 12px;
      transform: rotate(-14deg);
    }

    .kicker .ear.right {
      right: 12px;
      transform: rotate(14deg);
    }

    .kicker .ear:after {
      content: "";
      position: absolute;
      inset: 0;
      height: 14px;
      background: #1b1b1b;
      border-radius: 10px 10px 0 0;
      z-index: 9;
    }

    .kicker.shoot .body {
      animation: bump .18s ease;
    }

    @keyframes bump {
      50% {
        transform: scale(.95);
      }
    }

    /* 몬스터볼 느낌의 공 */
    .ball {
      --d: 40px;
      position: absolute;
      left: 50%;
      bottom: 14%;
      width: var(--d);
      height: var(--d);
      margin-left: calc(var(--d)/-2);
      border-radius: 50%;
      overflow: visible;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 14px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .ball .shell {
      position: relative;
      width: 88%;
      height: 88%;
      border-radius: 50%;
      background: linear-gradient(to bottom, #e53935 0%, #e53935 50%, #ffffff 50%, #f7f7f7 100%);
      border: 3px solid #111;
      box-shadow: inset 0 -4px 10px rgba(0, 0, 0, 0.12);
    }

    .ball .band {
      position: absolute;
      left: 7%;
      right: 7%;
      top: 46%;
      height: 14%;
      transform: translateY(-50%);
      background: #000;
      border-radius: 3px;
    }

    .ball .center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 34%;
      height: 34%;
      border-radius: 50%;
      background: #fff;
      border: 4px solid #111;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    .ball .shine {
      position: absolute;
      left: 22%;
      top: 14%;
      width: 26%;
      height: 20%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.95) 0 40%, transparent 41% 100%);
      border-radius: 50%;
      opacity: 0.95;
    }

    .aim {
      position: absolute;
      left: var(--goalLeft);
      right: var(--goalRight);
      top: var(--goalTop);
      height: var(--goalHeight);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      pointer-events: auto;
      padding: var(--aimInnerPad);
      z-index: 5;
    }

    .aim .cell {
      border: 2px dashed var(--arrow);
      border-radius: 8px;
      position: relative;
      cursor: pointer;
      border-color: var(--arrow-active);
      box-shadow: 0 0 0 3px #4e050533 inset;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
    }

    .aim .cell.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 6px var(--accent)22, 0 0 0 3px #ffffff22 inset;
    }

    .aim .cell::after {
      content: "•";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-weight: 900;
      color: #b40606bb;
    }

    .aim .cell[data-dir="0"]::after {
      content: "↖";
    }

    .aim .cell[data-dir="1"]::after {
      content: "↑";
    }

    .aim .cell[data-dir="2"]::after {
      content: "↗";
    }

    .aim .cell[data-dir="3"]::after {
      content: "←";
    }

    .aim .cell[data-dir="4"]::after {
      content: "•";
    }

    .aim .cell[data-dir="5"]::after {
      content: "→";
    }

    .aim .cell[data-dir="6"]::after {
      content: "↙";
    }

    .aim .cell[data-dir="7"]::after {
      content: "↓";
    }

    .aim .cell[data-dir="8"]::after {
      content: "↘";
    }

    #arena .message {
      position: absolute !important;
      left: 50% !important;
      top: calc(var(--goalTop) + var(--goalHeight) + 2%) !important;
      transform: translateX(-50%) !important;
      width: var(--msgW) !important;
      height: var(--msgH) !important;
      box-sizing: border-box !important;
      padding: 4px 8px !important;
      font-size: 11px !important;
      line-height: 11px !important;
      font-weight: 600 !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      display: none;
      align-items: center !important;
      justify-content: center !important;
      text-align: center !important;
      background: #263238 !important;
      border: 1px solid #00000040 !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 6px #0008 !important;
      color: #e0f2f1 !important;
      z-index: 50 !important;
    }

    #arena .message.goal {
      background: #2da7e5 !important;
    }

    #arena .message.save {
      background: #ed3853 !important;
    }

    #arena .message.show {
      display: inline-flex !important;
    }

    /* bottom centered Top10 table (순위 / 학번 / 연속골) */
    .bottomTableWrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 18px;
    }

    table.top10 {
      width: 420px;
      border-collapse: collapse;
      text-align: center;
      background: #0f1416;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    }

    table.top10 thead th {
      padding: 10px 6px;
      font-size: 13px;
      color: #cfeff5;
      background: linear-gradient(180deg, #111417, #0f1416);
      text-align: center;
    }

    table.top10 thead th.rank {
      text-align: center;
      width: 14%;
    }

    table.top10 thead th.id {
      text-align: center;
      width: 58%;
    }

    table.top10 thead th.score {
      text-align: center;
      width: 28%;
    }

    table.top10 tbody td {
      padding: 10px 6px;
      font-weight: 700;
      color: #eaf7f9;
      border-top: 1px solid rgba(255, 255, 255, 0.02);
      vertical-align: middle;
    }

    table.top10 tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.01);
    }

    table.top10 tbody td.rankCell {
      text-align: center;
      color: #98f0ff;
      font-weight: 900;
    }

    table.top10 tbody td.idCell {
      text-align: center;
      padding-left: 12px;
      color: #e6fbff;
    }

    table.top10 tbody td.scoreCell {
      text-align: center;
      padding-right: 12px;
      color: #ffd27a;
    }

    table.top10 tbody tr.empty td {
      padding: 12px;
      color: #8e9aa0;
      font-weight: 400;
      text-align: center;
    }

    @media (max-width:420px) {
      table.top10 {
        width: 92%;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>포켓몬 페널티킥 게임(장유고)</h1><br>
    <p class="tip">PC : 방향키로 방향 고정 후 Space바 슛팅</p>
    <p class="tip">스마트기기(가로모드) : 방향키 터치 후 몬스터볼 터치</p>
    <p class="tip">학번 입력 → Start 클릭 → 기록경신</p>

    <div class="hud">
      <div class="controls">
        <input id="studentId" class="input" placeholder="학번 (10101)" maxlength="5" inputmode="numeric" />
        <button id="startBtn" class="btn">Start</button>
      </div>
      <div class="badge">현재 조준: <span id="aimLabel">• (가운데)</span></div>
      <div class="badge">연속 골: <span id="streak">0</span></div>
      <div class="badge" style="background:#2b2b2b">최고: <span id="best">—</span></div>
    </div>

    <div class="arena" id="arena" tabindex="0" aria-label="페널티 구역">
      <div class="goal" aria-hidden="true"></div>
      <div class="line" aria-hidden="true"></div>
      <div class="spot" aria-hidden="true"></div>

      <div class="keeper" id="keeper" aria-hidden="true">
        <div class="head">
          <div class="eye left">
            <div class="pupil"></div>
          </div>
          <div class="eye right">
            <div class="pupil"></div>
          </div>
        </div>
        <div class="torso"></div>
        <div class="belly"></div>
        <div class="arm left"></div>
        <div class="arm right"></div>
        <div class="leg left"></div>
        <div class="leg right"></div>
        <div class="shell">
          <div class="panel"></div>
        </div>
      </div>

      <div class="kicker" id="kicker" aria-hidden="true">
        <div class="ear left" aria-hidden="true"></div>
        <div class="ear right" aria-hidden="true"></div>
        <div class="body"></div>
      </div>

      <div class="ball" id="ball" role="button" aria-label="슈팅" tabindex="0">
        <div class="shell" aria-hidden="true"></div>
        <div class="band" aria-hidden="true"></div>
        <div class="center" aria-hidden="true"></div>
        <div class="shine" aria-hidden="true"></div>
      </div>

      <div class="aim" id="aimGrid" role="group" aria-label="조준 그리드"></div>

      <div class="message" id="msg" aria-live="polite"></div>
    </div>

    <div class="bottomTableWrap" style="margin-top:20px;">
      <table class="top10" id="top10Table" aria-live="polite">
        <thead>
          <tr>
            <th class="rank">순위</th>
            <th class="id">학번</th>
            <th class="score">연속골</th>
          </tr>
        </thead>
        <tbody id="top10Body">
          <tr class="empty">
            <td colspan="3">로딩 중...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    /* Firebase modular SDK (Firestore) */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot,
      doc, getDoc, runTransaction, setDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzF6CGY4PcDrnQ9gInEPJsQI-ctpwupUM",
      authDomain: "pkgame-7464c.firebaseapp.com",
      projectId: "pkgame-7464c",
      storageBucket: "pkgame-7464c.firebasestorage.app",
      messagingSenderId: "332773265897",
      appId: "1:332773265897:web:7abb782f55daa85a073b78",
      measurementId: "G-398N8VPTMQ"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();

    /* ========== 게임 로직 (원본 흐름 유지) ========== */
    (() => {
      const arena = document.getElementById('arena');
      const keeper = document.getElementById('keeper');
      const kicker = document.getElementById('kicker');
      const ball = document.getElementById('ball');
      const msg = document.getElementById('msg');
      const streakEl = document.getElementById('streak');
      const aimLabel = document.getElementById('aimLabel');
      const aimGrid = document.getElementById('aimGrid');

      const studentInput = document.getElementById('studentId');
      const startBtn = document.getElementById('startBtn');
      const bestEl = document.getElementById('best');

      // 셀 생성
      const dirNames = ["↖ (왼-상)", "↑ (가-상)", "↗ (우-상)", "← (왼-가)", "• (가운데)", "→ (우-가)", "↙ (왼-하)", "↓ (가-하)", "↘ (우-하)"];
      const cells = [];
      for (let i = 0; i < 9; i++) {
        const c = document.createElement('div');
        c.className = 'cell';
        c.dataset.dir = i;
        c.setAttribute('tabindex', '0');
        c.setAttribute('role', 'button');
        c.setAttribute('aria-label', dirNames[i]);
        aimGrid.appendChild(c);
        cells.push(c);
      }

      let selected = 4, streak = 0, busy = false, msgTimer = null;
      let started = false, studentId = null, bestScore = 0;

      function updateAimHighlight() { cells.forEach(el => el.classList.toggle('active', +el.dataset.dir === selected)); aimLabel.textContent = dirNames[selected]; }
      updateAimHighlight();
      // ball 클릭/터치 이벤트 추가
      ball.addEventListener('click', () => {
        if (started) shoot();
      });

      ball.addEventListener('touchstart', (e) => {
        e.preventDefault(); // 터치 스크롤 방지
        if (started) shoot();
      }, { passive: false });

      function showMessage(text, type) { msg.textContent = text; msg.className = 'message show' + (type ? ' ' + type : ''); if (msgTimer) clearTimeout(msgTimer); msgTimer = setTimeout(() => { msg.classList.remove('show'); msgTimer = null; }, 1300); }

      function gridMove(dx, dy) { const x = selected % 3, y = Math.floor(selected / 3); const nx = Math.min(2, Math.max(0, x + dx)); const ny = Math.min(2, Math.max(0, y + dy)); selected = (ny * 3 + nx) | 0; updateAimHighlight(); }

      function placeKeeperHome() { const g = aimGrid.getBoundingClientRect(); const a = arena.getBoundingClientRect(); const kH = keeper.offsetHeight; const goalBottom = (g.top - a.top) + g.height; const topPx = goalBottom - kH + 10; keeper.style.top = `${Math.round(topPx)}px`; keeper.style.transform = 'translateX(-50%)'; }
      window.addEventListener('resize', placeKeeperHome); setTimeout(placeKeeperHome, 0);

      function animateBall(sx, sy, tx, ty, dur, done) { const start = performance.now(); function step(now) { const t = Math.min(1, (now - start) / dur); const ease = t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t; const x = sx + (tx - sx) * ease; const y = sy + (ty - sy) * ease - 40 * Math.sin(Math.PI * t); ball.style.transform = `translate(${x - sx}px, ${y - sy}px)`; if (t < 1) requestAnimationFrame(step); else done && done(); } requestAnimationFrame(step); }

      function randomOther(except) { const pool = [0, 1, 2, 3, 4, 5, 6, 7, 8].filter(n => n !== except); return pool[Math.floor(Math.random() * pool.length)]; }

      function shoot() {
        if (busy) return;
        busy = true; kicker.classList.add('shoot');

        const goalRect = aimGrid.getBoundingClientRect(); const arenaRect = arena.getBoundingClientRect();
        const col = selected % 3, row = Math.floor(selected / 3); const cellW = goalRect.width / 3, cellH = goalRect.height / 3;
        const targetX = (goalRect.left - arenaRect.left) + col * cellW + cellW / 2;
        const targetY = (goalRect.top - arenaRect.top) + row * cellH + cellH / 2;
        const start = ball.getBoundingClientRect(); const sx = start.left - arenaRect.left + start.width / 2; const sy = start.top - arenaRect.top + start.height / 2;
        const keeperPick = (Math.random() < 0.35) ? selected : randomOther(selected);

        const kW = keeper.offsetWidth, kH = keeper.offsetHeight;
        const kpCol = keeperPick % 3, kpRow = Math.floor(keeperPick / 3);
        let kTargetX = (goalRect.left - arenaRect.left) + kpCol * cellW + cellW / 2 - kW / 2;
        let kTargetY = (goalRect.top - arenaRect.top) + kpRow * cellH + cellH / 2 - kH / 2;
        if (keeperPick !== selected) {
          const dx = Math.sign(kpCol - col), dy = Math.sign(kpRow - row), offset = 28;
          kTargetX += dx * offset; kTargetY += dy * offset;
          const gxMin = (goalRect.left - arenaRect.left) - kW * 0.12; const gxMax = (goalRect.left - arenaRect.left) + goalRect.width - kW * 0.88;
          const gyMin = (goalRect.top - arenaRect.top) - kH * 0.12; const gyMax = (goalRect.top - arenaRect.top) + goalRect.height - kH * 0.88;
          kTargetX = Math.max(gxMin, Math.min(gxMax, kTargetX)); kTargetY = Math.max(gyMin, Math.min(gyMax, kTargetY));
        }

        const keeperRect = keeper.getBoundingClientRect();
        const startKX = keeperRect.left - arenaRect.left;
        const startKY = keeperRect.top - arenaRect.top;
        const dxDive = Math.round(kTargetX - startKX);
        const dyDive = Math.round(kTargetY - startKY);

        // Keep shell on top visually: add translate then restore
        keeper.style.transition = 'transform .36s ease';
        keeper.style.animation = 'none';
        requestAnimationFrame(() => { keeper.style.transform = `translateX(-50%) translate(${dxDive}px, ${dyDive}px)`; });

        const dur = 380;
        animateBall(sx, sy, targetX, targetY, dur, async () => {
          const saved = (keeperPick === selected);
          if (saved) {
            streak = 0; streakEl.textContent = streak; showMessage('아쉽다! 막혔어요 ⚡️🥅', 'save');
          } else {
            streak++; streakEl.textContent = streak; showMessage(`${streak}번째 연속 골! 🎉`, 'goal');
            if (started && studentId) {
              try {
                await tryUpdateHighScore(studentId, streak);
              } catch (err) {
                console.error('DB update error:', err);
              }
            }
          }

          setTimeout(() => { kicker.classList.remove('shoot'); keeper.style.transition = ''; keeper.style.animation = ''; keeper.style.transform = 'translateX(-50%)'; placeKeeperHome(); ball.style.transition = 'transform .22s ease'; ball.style.transform = 'translate(0,0)'; setTimeout(() => { ball.style.transition = ''; busy = false; }, 240); }, 200);
        });
      }

      // 키/셀 이벤트
      function isShootKey(e) { return e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar'; }
      function handleKey(e) {
        if (busy) return;
        if ((e.key.startsWith('Arrow') && e.repeat)) { e.preventDefault(); return; }
        if (e.key === 'ArrowLeft') { gridMove(-1, 0); e.preventDefault(); return; }
        if (e.key === 'ArrowRight') { gridMove(1, 0); e.preventDefault(); return; }
        if (e.key === 'ArrowUp') { gridMove(0, -1); e.preventDefault(); return; }
        if (e.key === 'ArrowDown') { gridMove(0, 1); e.preventDefault(); return; }
        if (isShootKey(e)) { e.preventDefault(); if (started) shoot(); }
      }
      arena.addEventListener('keydown', handleKey, false);
      setTimeout(() => arena.focus(), 200);

      cells.forEach((cell, i) => {
        cell.addEventListener('mouseenter', () => { selected = i; updateAimHighlight(); });
        cell.addEventListener('pointerdown', (e) => { e.preventDefault(); selected = i; updateAimHighlight(); }, { passive: false });
        cell.addEventListener('click', () => { selected = i; updateAimHighlight(); });
        cell.addEventListener('keydown', (e) => { if (e.key === 'Enter' || isShootKey(e)) { e.preventDefault(); selected = i; updateAimHighlight(); if (!busy && started) shoot(); } });
      });

      /* Firebase helpers used in-game */
      function normalizeStudentId(input) {
        if (!input) return null;
        const t = String(input).trim();
        if (!/^\d{4,5}$/.test(t)) return null;
        const n = parseInt(t, 10);
        if (n < 10101 || n > 11330) return null;
        return String(n);
      }

      async function fetchHighScoreSimple(id) {
        try {
          const snap = await getDoc(doc(db, 'scores', id));
          if (!snap.exists()) return 0;
          const data = snap.data(); return (data && typeof data.high === 'number') ? data.high : 0;
        } catch (e) { console.error('fetchHighScoreSimple error', e); throw e; }
      }

      async function tryUpdateHighScore(id, candidate) {
        if (typeof candidate !== 'number') candidate = Number(candidate);
        if (candidate <= (bestScore || 0)) return;
        const docRef = doc(db, 'scores', id);
        try {
          await runTransaction(db, async (t) => {
            const snap = await t.get(docRef);
            if (!snap.exists()) {
              t.set(docRef, { high: candidate, updatedAt: new Date().toISOString() });
              bestScore = candidate;
            } else {
              const cur = snap.data().high || 0;
              if (candidate > cur) {
                t.update(docRef, { high: candidate, updatedAt: new Date().toISOString() });
                bestScore = candidate;
              }
            }
          });
          bestEl.textContent = bestScore;
        } catch (e) {
          console.error('transaction failed', e);
          try {
            await setDoc(docRef, { high: candidate, updatedAt: new Date().toISOString() }, { merge: true });
            bestScore = candidate; bestEl.textContent = bestScore;
          } catch (e2) { console.error('fallback set failed', e2); }
        }
      }

      // Start 버튼 처리
      startBtn.addEventListener('click', async () => {
        const nid = normalizeStudentId(studentInput.value);
        if (!nid) { alert('학번은 10101~11330 범위의 숫자로 입력하세요.'); studentInput.focus(); return; }
        studentId = nid;
        startBtn.disabled = true;
        studentInput.disabled = true;
        showMessage('기록을 불러오는 중...', '');
        try {
          const hs = await fetchHighScoreSimple(studentId);
          bestScore = hs || 0; bestEl.textContent = bestScore > 0 ? bestScore : '0';
          streak = 0; streakEl.textContent = 0; started = true;
          showMessage('게임 시작! ⚽️', 'goal');
          setTimeout(() => arena.focus(), 120);
        } catch (e) {
          console.error('Start fetch error', e);
          alert('기록을 불러오지 못했습니다. 콘솔을 확인하세요.');
          startBtn.disabled = false;
          studentInput.disabled = false;
        }
      });

    })(); // IIFE end

    /* ========== Top10 실시간 구독 (순위·학번·연속골) ========== */
    const top10Body = document.getElementById('top10Body');
    try {
      const scoresCol = collection(db, 'scores');
      const q = query(scoresCol, orderBy('high', 'desc'), limit(10));
      onSnapshot(q, (snap) => {
        if (!snap || snap.empty) {
          top10Body.innerHTML = `<tr class="empty"><td colspan="3">기록이 없습니다.</td></tr>`;
          return;
        }
        const rows = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data() || {};
          rows.push({ id: docSnap.id, high: (typeof data.high === 'number') ? data.high : 0 });
        });
        top10Body.innerHTML = rows.map((r, i) => {
          return `<tr>
        <td class="rankCell">${i + 1}</td>
        <td class="idCell">${r.id}</td>
        <td class="scoreCell">${r.high}</td>
      </tr>`;
        }).join('');
      }, (err) => {
        console.error('Top10 onSnapshot error', err);
        top10Body.innerHTML = `<tr class="empty"><td colspan="3">실시간 로딩 실패</td></tr>`;
      });
    } catch (e) {
      console.error('Top10 init error', e);
      top10Body.innerHTML = `<tr class="empty"><td colspan="3">Top10 초기화 실패</td></tr>`;
    }
  </script>
</body>

</html>
